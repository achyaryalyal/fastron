====================
ALMALINUX-8 + CPANEL
====================

ssh root@[IP_ADDR]

yum -y update && yum -y upgrade && yum -y install perl curl nano firewalld && iptables-save > ~/firewall.rules && systemctl stop firewalld && systemctl disable firewalld

nano /etc/selinux/config
# change SELINUX=enforcing to SELINUX=disabled

swapon --show
fallocate -l 4G /swapfile && chmod 600 /swapfile
mkswap /swapfile && swapon /swapfile && swapon --show
nano /etc/fstab
# paste it at last line:
/swapfile swap swap defaults 0 0
# check again
swapon --show

hostnamectl set-hostname server.[YOUR_DOMAIN]
nano /etc/hosts
# tambahkan di baris paling bawah dengan format "IP public vps (spasi) hostname yang tadi ditambahkan"
# contoh: "123.234.345.212 server.[YOUR_DOMAIN]" (tanpa tanda kutip)
reboot

# tips & trick from https://support.cpanel.net/hc/en-us/articles/360052635434
# customize the version of MySQL or MariaDB used when installing cPanel for the first time
mkdir /root/cpanel_profile && nano /root/cpanel_profile/cpanel.config
# add one of the following example configurations to the file to specify your desired version of MySQL or MariaDB
mysql-version=10.6

# install & reboot to apply kernel and software updates
cd /home && curl -o latest -L https://securedownloads.cpanel.net/latest && sh latest && service NetworkManager start && chkconfig NetworkManager on && reboot

# while waiting for WHM installation to complete for about 20 minutes, let's set up our own nameservers
# login to your domain provider client area
# choose domain, go to "Private Name Server"
# add ns1 and ns2 with your server public IP, save
# go to "Nameservers", input ns1.[YOUR_DOMAIN] and ns2.[YOUR_DOMAIN], save

# after the WHM installation is complete, ssh again and fix short time login
nano /etc/ssh/sshd_config
# set:
	ClientAliveInterval 120
	ClientAliveCountMax 720
service sshd restart

# fix perl warning with glibc-langpack-[ID_COUNTRY] where the locale is Indonesia
yum -y install glibc-langpack-id && perl -v

# open WHM at https://serverIP:2087
# you will see warning "Your connection is not private", just click Advanced > Proceed
# username WHM: root
# password WHM: password of your server
# read cPanel terms and agree to all if you wish!
# in the next section, you should enter an email address to receive probable error notifications from WHM
# then you should enter 2 name servers. Name servers are used to connect your domain or subdomain to your WHM server
# ns1.[YOUR_DOMAIN] > configure address records > confirm the IPv4 address to create an A record
# ns2.[YOUR_DOMAIN] > configure address records > confirm the IPv4 address to create an A record

# open WHM > Networking Setup > Change Hostname
# change with your hostname server.[YOUR_DOMAIN]
# add an A Entry for Your Hostname

# install Let's Encrypt as Auto SSL Provider
/usr/local/cpanel/scripts/install_lets_encrypt_autossl_provider
# WHM > SSL/TLS > Manage AutoSSL
# in the Providers tab, select the Let's Encrypt option
# select "I agree to these terms of service option"
# select "Recreate my current registration with "Let's Encrypt"
# save

# install Self-Signed Certificate to Hostname
# WHM > Service Configuration > Manage Service SSL Certificates
# select the following services and click on "Browse Certificate"
# select hostname and click on "Use Certificates"
# then click on "Install" at the bottom of page
# once you have installed the self-signed certificate, run the following command to check SSL certificates
/usr/local/cpanel/bin/checkallsslcerts
# the self signed SSL certificates will be replaced with a valid Let's Encrypt certificate while running above command. Once it is completed, you can access WHM with the hostname https://[YOUR_HOSTNAME]:2087

# open WHM > Service Configuration > FTP Server Selection
# select one, save

# to start hosting a website, create a cPanel account on it
# read "From WHM to Website" at https://docs.cpanel.net/knowledge-base/accounts/from-whm-to-website/

# here are a few directories for cPanel installed stuff, in case we need to access it from the command line on AlmaLinux 8:
# cPanel directories: /usr/local/cpanel
# Third-party tools: /usr/local/cpanel/3rdparty/
# Directories of addons or cPanel add-ons: /usr/local/cpanel/addons/
# Basic files like PHPMyAdmin, themes: /usr/local/cpanel/base/
# cPanel binaries: /usr/local/cpanel/bin/
# CGI files: /usr/local/cpanel/cgi-sys/
# Access to cPanel & Error event files: /usr/local/cpanel/logs/
# WHM files: /usr/local/cpanel/whostmgr/
# Apache configuration: /etc/httpd/conf/httpd.conf
# Configuration of the Exim mail server: /etc/exim.conf
# Named configuration files: /etc/named.conf
# Configuration files ProFTP and Pureftpd: /etc/proftpd.conf and /etc/pure-ftpd.conf
# cPanel user files: /var/cpanel/users/username
# cPanel configuration files (tweak settings): /var/cpanel/cpanel.config
# Network configuration files: /etc/sysconfig/network
# Addons and subdomain information: /etc/userdomains
# cPanel update files: /etc/cpupdate.conf
# Clamav configuration files: /etc/clamav.conf
# MySQL configuration files: /etc/my.cnf
# PHP.ini configuration files: /usr/local/lib/php.ini

# install CSF (ConfigServer Security & Firewall)
yum -y install perl-libwww-perl perl-LWP-Protocol-https perl-GDGraph perl-Math-BigInt wget tar
cd /usr/src
rm -fv csf.tgz
wget https://download.configserver.com/csf.tgz
tar -xzf csf.tgz
cd csf
sh install.sh
# check if your cloud server has the required iptable modules
perl /usr/local/csf/bin/csftest.pl
# make sure you disable firewalld and any other iptables firewall
systemctl stop firewalld && systemctl disable firewalld
nano /etc/csf/csf.conf
	# change testing 1 to 0
	TESTING = "0"
systemctl restart csf && systemctl restart lfd
systemctl enable csf && systemctl enable lfd
systemctl status csf && systemctl status lfd
# restart CSF Firewall
csf -r
