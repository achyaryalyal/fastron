===================================
Install EPrints on Ubuntu 22.04 LTS
===================================
sudo apt-get update -y && apt-get upgrade -y && apt-get autoremove -y --purge && apt-get autoclean -y
sudo apt-get install -y nano ntp neofetch curl wget git zip unzip rar unrar
hostnamectl set-hostname [YOUR_HOSTNAME] && hostname
nano /etc/ssh/sshd_config
# set:
	LoginGraceTime 120
	ClientAliveInterval 120
	ClientAliveCountMax 720
service ssh restart
systemctl enable ntp && dpkg-reconfigure tzdata && date
swapon --show
fallocate -l 4G /swapfile && chmod 600 /swapfile
mkswap /swapfile && swapon /swapfile && swapon --show
nano /etc/fstab
# paste it at last line:
/swapfile swap swap defaults 0 0
# check again
swapon --show

nano /etc/apt/sources.list.d/eprints.list
deb http://deb.eprints-hosting.org/3.4/stable/ ./
wget -O /etc/apt/trusted.gpg.d/eprints.gpg http://deb.eprints.org/keyFile.gpg && apt-get update

# install xpdf
apt install libpoppler-dev xpdf -y

# install eprints
apt install eprints -y
# it will be installed to: /usr/share/eprints/

# set password for mysql
mysql -u root
USE mysql;
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '[YOUR_PASSWORD]';
FLUSH PRIVILEGES;
exit

# install publications flavour
wget https://files.eprints.org/2715/2/eprints-3.4.4-flavours.tar.gz
tar -xzvf eprints-3.4.4-flavours.tar.gz -C /usr/share/eprints/
mv /usr/share/eprints/eprints-3.4.4/flavours /usr/share/eprints/
rmdir /usr/share/eprints/eprints-3.4.4/
rm eprints-3.4.4-flavours.tar.gz

sudo su eprints
cd /usr/share/eprints/
./bin/epadmin create pub
# Archive ID? eprints
# Configure vital settings? [yes] ? ENTER
# Hostname? [YOUR_SUBDOMAIN]
# Webserver Port [80] ? ENTER
# Alias (enter # when done) [#] ? ENTER
# Path [/] ? ENTER
# HTTPS Hostname [] ? ENTER
# Administrator Email? [YOUR_SYSTEM_EMAIL_OR_ADMIN_EMAIL]
# Archive Name [Test Repository] ? [YOUR_REPOSITORY_NAME]
# Organisation Name [Organisation of Test] ? [YOUR_ORG_NAME]
# Write these core settings? [yes] ? ENTER
# Configure database? [yes] ? ENTER
# Database Name [eprints] ? ENTER
# MySQL Host [localhost] ? ENTER
# MySQL Port (# for no setting) [#] ? ENTER
# MySQL Socket (# for no setting) [#] ? ENTER
# Database User [eprints] ? ENTER
# Database Password [h6oJF41f] ENTER
# Database Engine [InnoDB] ? ENTER
# Write these database settings? [yes] ? ENTER
# Create database "eprints" [yes] ? ENTER
# Database Superuser Username [root] ? ENTER
# Database Superuser Password? [YOUR_PASSWORD]
# Create database tables? [yes] ? ENTER
# Create an initial user? [yes] ? ENTER
# Enter a username [admin] ? ENTER
# Select a user type (user|editor|admin) [admin] ? ENTER
# Do you want to build the static web pages? [yes] ? ENTER
# Do you want to import the LOC subjects and sample divisions? [yes] ? ENTER
# Do you want to update the apache config files? (you still need to add the 'Include' line) [yes] ? ENTER
exit
a2enmod rewrite env headers mime dir ssl setenvif
a2ensite eprints
apachectl configtest
systemctl reload apache2

crontab -e
	30 0 * * * php -r 'sleep(rand(0,1799));' && apt update -y >/dev/null 2>&1 && apt upgrade -y >/dev/null 2>&1

# go to your subdomain with http://[YOUR_SUBDOMAIN]





















# install let's encrypt
sudo apt install -y certbot python3-certbot-apache && certbot --version
openssl dhparam -dsaparam -out /etc/apache2/dhparam.pem 4096
mkdir /usr/share/eprints/.well-known/
mkdir /usr/share/eprints/.well-known/acme-challenge/
chown www-data:www-data -R /usr/share/eprints/.well-known/
certbot certonly --dry-run --email [ALAMAT_EMAIL_KHUSUS_UNTUK_EPRINTS] --agree-tos --rsa-key-size 4096 --webroot -w /usr/share/eprints -d [YOUR_SUBDOMAIN]
certbot certonly --email [ALAMAT_EMAIL_KHUSUS_UNTUK_EPRINTS] --agree-tos --rsa-key-size 4096 --webroot -w /usr/share/eprints -d [YOUR_SUBDOMAIN]

nano /etc/apache2/sites-available/000-default.conf

<VirtualHost *:80>
ServerAdmin webmaster@localhost
DocumentRoot /usr/share/eprints
DirectoryIndex index.php
<Directory /usr/share/eprints>
Options -Indexes +IncludesNOEXEC +SymLinksIfOwnerMatch +ExecCGI
AllowOverride All Options=ExecCGI,Includes,IncludesNOEXEC,Indexes,MultiViews,SymLinksIfOwnerMatch
allow from all
Require all granted
</Directory>
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
<VirtualHost *:443>
ServerAdmin webmaster@localhost
DocumentRoot /usr/share/eprints
DirectoryIndex index.php
SSLEngine on
SSLCertificateFile "/etc/letsencrypt/live/[YOUR_SUBDOMAIN]/fullchain.pem"
SSLCertificateKeyFile "/etc/letsencrypt/live/[YOUR_SUBDOMAIN]/privkey.pem"
SSLOpenSSLConfCmd DHParameters "/etc/apache2/dhparam.pem"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
SSLProtocol all -SSLv3
SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA
SSLHonorCipherOrder on
SSLCompression off
SSLSessionTickets off
<Directory /usr/share/eprints>
Options -Indexes +IncludesNOEXEC +SymLinksIfOwnerMatch +ExecCGI
AllowOverride All Options=ExecCGI,Includes,IncludesNOEXEC,Indexes,MultiViews,SymLinksIfOwnerMatch
allow from all
Require all granted
</Directory>
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

apachectl configtest
systemctl reload apache2

# go to your subdomain with https://[YOUR_SUBDOMAIN]

# don't forget to register your repository at http://roar.eprints.org/

# Troubleshoot: MySQL root user cannot be used
CREATE USER 'eprints'@'localhost' IDENTIFIED by 'changeme';
GRANT ALL PRIVILEGES ON *.* TO 'eprints'@'localhost' WITH GRANT OPTION;

# Troubleshoot: Untuk edit page seperti menambah logo header itu dimana ya?
# menambahkan Logo di Eprints 3.4.3 Pub dan Mengganti Tema: https://www.youtube.com/watch?v=FhHnO1DQj_s
# bisa dicopy dari themes eprints yang lama ke config archives
# kemudian brand.pl yang ada di lib/cfg.d di copy kedalam config archives kita
# kemudian panggil nama themesnya

# Make sure you remove or disable your archive's cfg/cfg.d/https.pl if it exists as it may override the configuration below. Once you have updated your configuration you must run generate_apacheconf to regenerate configuration for Apache before restarting the web server.
# config HTTP Only
$c->{host} = 'example.eprints.org';
$c->{port} = 80;
$c->{securehost} = undef;
$c->{secureport} = undef;
# config HTTPS When You Login
$c->{host} = 'example.eprints.org';
$c->{port} = 80;
$c->{securehost} = $c->{host};
$c->{secureport} = 443;
# config HTTPS Only
$c->{host} = undef;
$c->{port} = 80;
$c->{securehost} = 'example.eprints.org';
$c->{secureport} = 443;
